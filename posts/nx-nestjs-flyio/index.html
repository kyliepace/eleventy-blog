<!DOCTYPE html>
<html lang="en">
  <head>
    
    
    
    <meta charset="utf-8" />
    <link rel="icon" href="https://kyliepace.imgix.net/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="TypeScript, NodeJS, NestJS, women in tech" />
    <link rel="stylesheet" type="text/css" href="/public/style.css" />
    <meta name="google-site-verification" content="qbNROqebONSW5MNT3Qs2Q4O2z7ZnCHMbKeYOyonsWx4" />
    <title>Deploying an nx monorepo of nestjs apps to fly.dev - Code Cadette</title>

<meta name="description" content="a typescript tech blog for Code Cadettes">
<meta name="robots" content="index,follow">
<meta name="author" content="Kylie Pace">

<link rel="canonical" href="https://www.codecadette.com/posts/nx-nestjs-flyio/">

<meta property="og:title" content="Deploying an nx monorepo of nestjs apps to fly.dev - Code Cadette">
<meta property="og:type" content="article">

<meta property="og:url" content="https://www.codecadette.com/posts/nx-nestjs-flyio/">
<meta property="og:description" content="a typescript tech blog for Code Cadettes">
<meta property="og:image" content="💪🏼">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@kylie_the_first">
<meta name="twitter:url" content="https://www.codecadette.com/posts/nx-nestjs-flyio/">
<meta name="twitter:title" content="Deploying an nx monorepo of nestjs apps to fly.dev - Code Cadette">
<meta name="twitter:description" content="a typescript tech blog for Code Cadettes">
<meta name="twitter:image" content="💪🏼">



    <script src="https://getinsights.io/js/insights.js"></script>
    <script>
      insights.init('if5aErcP9v425y8M');    
      insights.trackPages()
    </script>
  </head>
  <body>
  <main>
    
    
  
    


<div class="wrapper post">
  <div class="title">

    
    <h1 class='postTitle'>Deploying an nx monorepo of nestjs apps to fly.dev</h1>
    <p>2022-04-25
    <p>
      <em></em>
    </p>    
  </div>
  <div>
    
    <p>In this post, we'll go over how to deploy nestjs microservices to <a href="fly.io">fly.io</a>.</p>
<p>Fly.io deploys docker images at the edge using AWS Firecracker to distribute lots of little VMs close to your apps' users. I like that it doesn't have the v8 limitations of cloudflare workers and manages devops for a lovely developer experience.</p>
<h2>poc</h2>
<p>Since I'm working with nestjs, I first had to add a Dockerfile to build my nestjs application as an image. I followed <a href="https://github.com/fly-apps/fly-nestjs">this example in the fly-apps repo</a>. <a href="https://fly.io/docs/getting-started/installing-flyctl/">Installing flyctl</a> and running <code>flyctl launch</code> deployed my entire repo application to a fly.dev domain.</p>
<h2>Getting started</h2>
<p>I used <a href="https://nx.dev/">nx</a> to generate separate nestjs apps within the same github repo, following the documentation for <a href="https://nx.dev/nest/overview">nx's nestjs plugin</a>.</p>
<p>My project structure looked like this:</p>
<pre><code>.
├── apps/
│   ├── api/
│   │   ├── src
│   │   │   ├── // source files
│   │   ├── jest.config.js
│   │   ├── tsconfig.app.json
│   │   ├── tsconfig.json
│   │   └── tsconfig.spec.json
│   └── html/
│   │   ├── src
│   │   │   ├── // source files
│   │   ├── jest.config.js
│   │   ├── tsconfig.app.json
│   │   ├── tsconfig.json
│   │   └── tsconfig.spec.json
├── libs/
│   └── todos/
├── tools/
├── jest.config.js
├── jest.preset.js
├── nx.json
├── package.json
├── tsconfig.base.json
└── workspace.json
</code></pre>
<p>Instead of adding a Dockerfile to the project root, I want one separate Dockerfile per nestjs app.</p>
<p>My Dockerfile instructions were now different than in the POC example. Here's what my dockerfile looks like:</p>
<pre><code class="language-apps/api/Dockerfile">FROM node:lts-alpine
WORKDIR /app
COPY ./dist/apps/api .
ENV PORT=3333
EXPOSE ${PORT}
RUN yarn install --production
# dependencies that nestjs needs
RUN yarn add reflect-metadata tslib rxjs @nestjs/platform-express
CMD node ./main.js
</code></pre>
<p>When I first ran <code>flyctl launch --dockerfile ./apps/api/Dockerfile</code>, the <code>fly.toml</code> file was created in the wrong place, at the project root. I moved it into the apps/api directory and changed some port variables to match how I had defined things in the Dockerfile.</p>
<pre><code class="language-apps/api/fly.toml">
app = &quot;(fly.dev host here)&quot;

[env]
  PORT = &quot;3333&quot;

[[services]]
  http_checks = []
  internal_port = 3333
  processes = [&quot;app&quot;]
  protocol = &quot;tcp&quot;
  script_checks = []

  [services.concurrency]
    hard_limit = 25
    soft_limit = 20
    type = &quot;connections&quot;

  [[services.ports]]
    force_https = true
    handlers = [&quot;http&quot;]
    port = 80

  [[services.ports]]
    handlers = [&quot;tls&quot;, &quot;http&quot;]
    port = 443

  [[services.tcp_checks]]
    grace_period = &quot;1s&quot;
    interval = &quot;15s&quot;
    restart_limit = 6
    timeout = &quot;2s&quot;
</code></pre>
<p>Then from the project root running <code>flyctl deploy --config ./apps/api/fly.toml --dockerfile ./apps/api/Dockerfile</code> deploys just the api app to its own fly.dev url.</p>

    <div class="controls">
    
    
    
      <p>
        <strong>Next post</strong>: 
        <a class="next" href="/posts/nestjs-api-graphql-prisma-mongodb/">Building a NestJS GraphQL API with Prisma and MongoDB</a>
      </p>
    
    </div>
  </div>
</div>

      <footer class="footer">
        <div class="links">
          <a href="/">🪴 Home</a>
          <span class="divider">|</span>
          <a href="/posts">📝 Posts</a>
          <span class="divider">|</span>
          <a href="/about">🕶 About</a>
          <span class="divider">|</span>
          <a href="https://kyliepace.github.io/book-blog">📖 Secret Bookish Blog</a>
          <a class="right" href="https://www.github.com/kyliepace">github</a>
        </div>
      </footer>
    
  </main>
   
  </body>
</html>